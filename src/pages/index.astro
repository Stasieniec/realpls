---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import UploadArea from '../components/UploadArea.astro';
import ReportView from '../components/ReportView.astro';
---

<Layout title="realpls — Quick, local image authenticity checks">
  <Header />
  
  <main class="main container">
    <!-- Hero Section (shown before upload) -->
    <section class="hero" id="hero-section">
      <div class="hero-content">
        <h1 class="hero-title">
          Quick image authenticity checks
        </h1>
        <p class="hero-subtitle">
          Analyze images for potential manipulation directly in your browser. 
          No uploads, no tracking, complete privacy.
        </p>
      </div>
      
      <UploadArea />
      
      <div class="features">
        <div class="feature">
          <div class="feature-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="1.5"/>
              <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
          </div>
          <h3 class="feature-title">Instant Analysis</h3>
          <p class="feature-text">Results in seconds, all processing happens locally</p>
        </div>
        
        <div class="feature">
          <div class="feature-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 1L3 5V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V5L12 1Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <h3 class="feature-title">100% Private</h3>
          <p class="feature-text">Your images never leave your device</p>
        </div>
        
        <div class="feature">
          <div class="feature-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21 21L16.65 16.65M19 11C19 15.4183 15.4183 19 11 19C6.58172 19 3 15.4183 3 11C3 6.58172 6.58172 3 11 3C15.4183 3 19 6.58172 19 11Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
          </div>
          <h3 class="feature-title">Multiple Checks</h3>
          <p class="feature-text">Metadata, compression, pixel analysis & more</p>
        </div>
      </div>
    </section>
    
    <!-- Report Section (shown after upload) -->
    <section class="report-section" id="report-section">
      <ReportView />
    </section>
  </main>
  
  <Footer />
</Layout>

<script>
  import { 
    loadImage, 
    runForensicPipeline, 
    exportReportJSON, 
    getStatusMessage,
    formatFileSize,
    type ForensicReport,
    type CheckResult,
    type ImageFile
  } from '../lib/forensics';
  
  // DOM Elements
  const heroSection = document.getElementById('hero-section')!;
  const reportSection = document.getElementById('report-section')!;
  const reportView = document.getElementById('report-view')!;
  const uploadArea = document.getElementById('upload-area')!;
  const uploadContent = uploadArea.querySelector('.upload-content')!;
  const uploadLoading = document.getElementById('upload-loading')!;
  const fileInput = document.getElementById('file-input') as HTMLInputElement;
  const demoButton = document.getElementById('demo-button')!;
  const resetButton = document.getElementById('reset-button')!;
  const downloadButton = document.getElementById('download-button')!;
  
  // Report elements
  const summaryBanner = document.getElementById('summary-banner')!;
  const summaryIcon = document.getElementById('summary-icon')!;
  const summaryTitle = document.getElementById('summary-title')!;
  const summarySubtitle = document.getElementById('summary-subtitle')!;
  const summaryStats = document.getElementById('summary-stats')!;
  const analysisProgress = document.getElementById('analysis-progress')!;
  const progressFill = document.getElementById('progress-fill')!;
  const progressText = document.getElementById('progress-text')!;
  const reportContent = document.getElementById('report-content')!;
  const previewImage = document.getElementById('preview-image') as HTMLImageElement;
  const overlayCanvas = document.getElementById('overlay-canvas') as HTMLCanvasElement;
  const filename = document.getElementById('filename')!;
  const fileMeta = document.getElementById('file-meta')!;
  const overlayControls = document.getElementById('overlay-controls')!;
  const overlaySelect = document.getElementById('overlay-select') as HTMLSelectElement;
  const opacitySlider = document.getElementById('opacity-slider') as HTMLInputElement;
  const tabContent = document.getElementById('tab-content')!;
  
  // State
  let currentReport: ForensicReport | null = null;
  let currentImageFile: ImageFile | null = null;
  let overlays: Map<string, ImageData> = new Map();
  
  // Tab handling
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => {
        t.classList.remove('active');
        t.setAttribute('aria-selected', 'false');
      });
      tab.classList.add('active');
      tab.setAttribute('aria-selected', 'true');
      
      const tabName = tab.getAttribute('data-tab')!;
      renderTabContent(tabName);
    });
  });
  
  // Drag and drop
  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
  });
  
  uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
  });
  
  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    
    const files = e.dataTransfer?.files;
    if (files && files.length > 0) {
      handleFile(files[0]);
    }
  });
  
  // File input
  fileInput.addEventListener('change', () => {
    if (fileInput.files && fileInput.files.length > 0) {
      handleFile(fileInput.files[0]);
    }
  });
  
  // Demo button
  demoButton.addEventListener('click', async (e) => {
    e.stopPropagation();
    try {
      const response = await fetch('/demo/sample.jpg');
      const blob = await response.blob();
      const file = new File([blob], 'demo-image.jpg', { type: 'image/jpeg' });
      handleFile(file);
    } catch (error) {
      console.error('Failed to load demo image:', error);
      alert('Failed to load demo image. Please try uploading your own image.');
    }
  });
  
  // Reset button
  resetButton.addEventListener('click', () => {
    resetView();
  });
  
  // Download button
  downloadButton.addEventListener('click', () => {
    if (currentReport) {
      const json = exportReportJSON(currentReport);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `forensic-report-${currentReport.filename}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }
  });
  
  // Overlay controls
  overlaySelect.addEventListener('change', () => {
    updateOverlay();
  });
  
  opacitySlider.addEventListener('input', () => {
    updateOverlay();
  });
  
  // Handle file upload
  async function handleFile(file: File) {
    // Validate file size
    if (file.size > 50 * 1024 * 1024) {
      alert('File too large. Maximum size is 50MB.');
      return;
    }
    
    // Show loading
    uploadContent.classList.add('hidden');
    uploadLoading.classList.remove('hidden');
    
    try {
      // Load image
      currentImageFile = await loadImage(file);
      
      // Show report view
      heroSection.classList.add('hidden');
      reportView.classList.remove('hidden');
      reportContent.classList.add('hidden');
      analysisProgress.classList.remove('hidden');
      
      // Set preview
      previewImage.src = currentImageFile.dataUrl;
      filename.textContent = file.name;
      fileMeta.textContent = `${currentImageFile.width}×${currentImageFile.height} • ${formatFileSize(file.size)}`;
      
      // Run analysis
      currentReport = await runForensicPipeline(currentImageFile, {
        onProgress: (stage, progress) => {
          progressFill.style.width = `${progress}%`;
          progressText.textContent = stage;
        }
      });
      
      // Hide progress, show content
      analysisProgress.classList.add('hidden');
      reportContent.classList.remove('hidden');
      
      // Update summary
      updateSummary();
      
      // Collect overlays
      collectOverlays();
      
      // Render initial tab
      renderTabContent('overview');
      
    } catch (error) {
      console.error('Analysis failed:', error);
      alert(`Failed to analyze image: ${error instanceof Error ? error.message : 'Unknown error'}`);
      resetView();
    }
  }
  
  function resetView() {
    heroSection.classList.remove('hidden');
    reportView.classList.add('hidden');
    uploadContent.classList.remove('hidden');
    uploadLoading.classList.add('hidden');
    fileInput.value = '';
    currentReport = null;
    currentImageFile = null;
    overlays.clear();
    overlaySelect.innerHTML = '<option value="none">None</option>';
    overlayCanvas.classList.add('hidden');
    overlayControls.classList.add('hidden');
  }
  
  function updateSummary() {
    if (!currentReport) return;
    
    const { overallStatus, summary } = currentReport;
    
    // Update banner class
    summaryBanner.className = `summary-banner status-${overallStatus}`;
    
    // Update icon
    const icons = {
      clean: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M9 12l2 2 4-4" stroke="var(--color-ok)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="12" cy="12" r="9" stroke="var(--color-ok)" stroke-width="2"/>
      </svg>`,
      review: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 9v2m0 4h.01M12 3l9.196 15H2.804L12 3z" stroke="var(--color-warn)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>`,
      suspicious: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="12" cy="12" r="9" stroke="var(--color-fail)" stroke-width="2"/>
        <path d="M15 9l-6 6m0-6l6 6" stroke="var(--color-fail)" stroke-width="2" stroke-linecap="round"/>
      </svg>`
    };
    summaryIcon.innerHTML = icons[overallStatus];
    
    // Update text
    summaryTitle.textContent = getStatusMessage(overallStatus);
    summarySubtitle.textContent = `${currentReport.checks.length} checks completed`;
    
    // Update stats
    summaryStats.innerHTML = `
      <div class="stat-item">
        <div class="stat-value" style="color: var(--color-ok)">${summary.okCount}</div>
        <div class="stat-label">OK</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" style="color: var(--color-warn)">${summary.warnCount}</div>
        <div class="stat-label">Warn</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" style="color: var(--color-info)">${summary.infoCount}</div>
        <div class="stat-label">Info</div>
      </div>
    `;
  }
  
  function collectOverlays() {
    if (!currentReport) return;
    
    overlays.clear();
    
    for (const check of currentReport.checks) {
      if (check.overlay) {
        overlays.set(check.id, check.overlay);
      }
    }
    
    // Update select options
    overlaySelect.innerHTML = '<option value="none">None</option>';
    
    const overlayNames: Record<string, string> = {
      'noise-consistency': 'Noise Map',
      'edge-consistency': 'Edge Map',
      'ela': 'Error Level Analysis',
    };
    
    for (const [id] of overlays) {
      const option = document.createElement('option');
      option.value = id;
      option.textContent = overlayNames[id] || id;
      overlaySelect.appendChild(option);
    }
    
    if (overlays.size > 0) {
      overlayControls.classList.remove('hidden');
    }
  }
  
  function updateOverlay() {
    const selected = overlaySelect.value;
    const opacity = parseInt(opacitySlider.value) / 100;
    
    if (selected === 'none' || !overlays.has(selected)) {
      overlayCanvas.classList.add('hidden');
      return;
    }
    
    const overlayData = overlays.get(selected)!;
    
    // Resize canvas to match image display size
    const imageRect = previewImage.getBoundingClientRect();
    const containerRect = previewImage.parentElement!.getBoundingClientRect();
    
    overlayCanvas.width = overlayData.width;
    overlayCanvas.height = overlayData.height;
    overlayCanvas.style.width = `${imageRect.width}px`;
    overlayCanvas.style.height = `${imageRect.height}px`;
    overlayCanvas.style.opacity = String(opacity);
    
    const ctx = overlayCanvas.getContext('2d')!;
    ctx.putImageData(overlayData, 0, 0);
    
    overlayCanvas.classList.remove('hidden');
  }
  
  function renderTabContent(tabName: string) {
    if (!currentReport) return;
    
    const checks = currentReport.checks;
    
    switch (tabName) {
      case 'overview':
        renderOverviewTab(checks);
        break;
      case 'metadata':
        renderMetadataTab(checks);
        break;
      case 'forensics':
        renderForensicsTab(checks);
        break;
      case 'visualize':
        renderVisualizeTab(checks);
        break;
    }
  }
  
  function renderOverviewTab(checks: CheckResult[]) {
    // Show all checks grouped by status
    const warnings = checks.filter(c => c.status === 'warn');
    const infos = checks.filter(c => c.status === 'info');
    const oks = checks.filter(c => c.status === 'ok');
    
    let html = '';
    
    if (warnings.length > 0) {
      html += `<h4 style="margin-bottom: var(--space-3); color: var(--color-warn);">Warnings (${warnings.length})</h4>`;
      warnings.forEach(check => {
        html += renderCheckCard(check);
      });
    }
    
    if (infos.length > 0) {
      html += `<h4 style="margin: var(--space-4) 0 var(--space-3); color: var(--color-info);">Information (${infos.length})</h4>`;
      infos.forEach(check => {
        html += renderCheckCard(check);
      });
    }
    
    if (oks.length > 0) {
      html += `<h4 style="margin: var(--space-4) 0 var(--space-3); color: var(--color-ok);">Passed (${oks.length})</h4>`;
      oks.forEach(check => {
        html += renderCheckCard(check);
      });
    }
    
    tabContent.innerHTML = html;
    attachCheckCardListeners();
  }
  
  function renderMetadataTab(checks: CheckResult[]) {
    const metadataChecks = checks.filter(c => 
      ['exif-presence', 'editing-software', 'file-type', 'file-properties', 'animation'].includes(c.id)
    );
    
    if (metadataChecks.length === 0) {
      tabContent.innerHTML = renderEmptyState('No metadata checks available');
      return;
    }
    
    let html = '';
    metadataChecks.forEach(check => {
      html += renderCheckCard(check, true);
    });
    
    tabContent.innerHTML = html;
    attachCheckCardListeners();
  }
  
  function renderForensicsTab(checks: CheckResult[]) {
    const forensicChecks = checks.filter(c => 
      ['jpeg-quality', 'double-compression', 'uniform-areas', 'noise-consistency', 
       'edge-consistency', 'clone-detection', 'ela', 'social-media-hint'].includes(c.id)
    );
    
    if (forensicChecks.length === 0) {
      tabContent.innerHTML = renderEmptyState('No forensic checks available');
      return;
    }
    
    let html = '';
    forensicChecks.forEach(check => {
      html += renderCheckCard(check, true);
    });
    
    tabContent.innerHTML = html;
    attachCheckCardListeners();
  }
  
  function renderVisualizeTab(checks: CheckResult[]) {
    const visualChecks = checks.filter(c => c.overlay);
    
    let html = `
      <div style="margin-bottom: var(--space-4);">
        <p style="color: var(--color-text-secondary); font-size: var(--text-sm);">
          Use the overlay controls below the image to visualize different analysis results.
          Adjust the opacity slider to see the overlay over the original image.
        </p>
      </div>
    `;
    
    if (visualChecks.length === 0) {
      html += `
        <div class="empty-state">
          <p>No visual overlays available for this image.</p>
        </div>
      `;
    } else {
      html += `<h4 style="margin-bottom: var(--space-3);">Available Overlays</h4>`;
      visualChecks.forEach(check => {
        html += renderCheckCard(check);
      });
    }
    
    tabContent.innerHTML = html;
    attachCheckCardListeners();
  }
  
  function renderCheckCard(check: CheckResult, expanded = false): string {
    const statusIcons = {
      ok: `<span class="check-badge" style="background: var(--color-ok-bg); color: var(--color-ok); padding: 2px 8px; border-radius: 9999px; font-size: 12px; font-weight: 500;">OK</span>`,
      warn: `<span class="check-badge" style="background: var(--color-warn-bg); color: var(--color-warn); padding: 2px 8px; border-radius: 9999px; font-size: 12px; font-weight: 500;">Warning</span>`,
      fail: `<span class="check-badge" style="background: var(--color-fail-bg); color: var(--color-fail); padding: 2px 8px; border-radius: 9999px; font-size: 12px; font-weight: 500;">Issue</span>`,
      info: `<span class="check-badge" style="background: var(--color-info-bg); color: var(--color-info); padding: 2px 8px; border-radius: 9999px; font-size: 12px; font-weight: 500;">Info</span>`,
    };
    
    const detailsHtml = Object.entries(check.details)
      .map(([key, value]) => `
        <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--color-border);">
          <span style="color: var(--color-text-muted); font-size: 13px;">${key}</span>
          <span style="font-family: var(--font-mono); font-size: 13px;">${value ?? '—'}</span>
        </div>
      `).join('');
    
    return `
      <div class="check-card ${expanded ? 'expanded' : ''}">
        <div class="check-header" tabindex="0" role="button" aria-expanded="${expanded}">
          ${statusIcons[check.status]}
          <div class="check-info">
            <div class="check-name">${check.name}</div>
            <div class="check-summary">${check.summary}</div>
          </div>
          <svg class="check-expand" width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="check-details">
          ${detailsHtml}
          <div class="confidence-bar">
            <label>Confidence:</label>
            <div class="confidence-track">
              <div class="confidence-fill" style="width: ${check.confidence * 100}%"></div>
            </div>
            <span class="confidence-value">${Math.round(check.confidence * 100)}%</span>
          </div>
          ${check.notes ? `<div class="check-notes">${check.notes}</div>` : ''}
        </div>
      </div>
    `;
  }
  
  function renderEmptyState(message: string): string {
    return `
      <div class="empty-state">
        <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="24" cy="24" r="20" stroke="currentColor" stroke-width="2"/>
          <path d="M24 16V26" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <circle cx="24" cy="32" r="1.5" fill="currentColor"/>
        </svg>
        <p>${message}</p>
      </div>
    `;
  }
  
  function attachCheckCardListeners() {
    document.querySelectorAll('.check-header').forEach(header => {
      header.addEventListener('click', () => {
        const card = header.parentElement!;
        card.classList.toggle('expanded');
        const isExpanded = card.classList.contains('expanded');
        header.setAttribute('aria-expanded', String(isExpanded));
      });
      
      header.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          (header as HTMLElement).click();
        }
      });
    });
  }
</script>

<style>
  .main {
    flex: 1;
    padding-top: var(--space-10);
    padding-bottom: var(--space-10);
  }
  
  /* Hero */
  .hero {
    max-width: var(--container-narrow);
    margin-inline: auto;
  }
  
  .hero-content {
    text-align: center;
    margin-bottom: var(--space-10);
  }
  
  .hero-title {
    font-size: clamp(var(--text-3xl), 5vw, var(--text-4xl));
    font-weight: 600;
    letter-spacing: -0.02em;
    margin-bottom: var(--space-4);
    background: linear-gradient(135deg, var(--color-text) 0%, var(--color-text-secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .hero-subtitle {
    font-size: var(--text-lg);
    color: var(--color-text-secondary);
    max-width: 480px;
    margin-inline: auto;
    line-height: var(--leading-relaxed);
  }
  
  /* Features */
  .features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-6);
    margin-top: var(--space-12);
  }
  
  .feature {
    text-align: center;
    padding: var(--space-6);
    background: var(--color-bg-elevated);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    transition: all var(--transition-normal);
  }
  
  .feature:hover {
    border-color: var(--color-border-subtle);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }
  
  .feature-icon {
    width: 48px;
    height: 48px;
    margin-inline: auto;
    margin-bottom: var(--space-4);
    color: var(--color-accent);
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-accent-subtle);
    border-radius: var(--radius-lg);
  }
  
  .feature-title {
    font-size: var(--text-base);
    font-weight: 600;
    margin-bottom: var(--space-2);
  }
  
  .feature-text {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
  }
  
  /* Report Section */
  .report-section {
    max-width: var(--container-max);
    margin-inline: auto;
  }
  
  .hidden {
    display: none !important;
  }
</style>

